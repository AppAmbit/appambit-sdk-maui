name: Build and Publish NuGet Package

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build
    timeout-minutes: 20
    env:
      NUPKG_MAJOR: 0.999
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install .NET MAUI
        run: |
          dotnet nuget locals all --clear
          dotnet workload install maui --source https://api.nuget.org/v3/index.json
          dotnet workload install android ios maccatalyst tvos macos maui wasm-tools maui-maccatalyst --source https://api.nuget.org/v3/index.json

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release

      - name: Get project version
        id: project_version
        run: |
          VERSION=$(grep -oP '<Version>\K[^<]+' ./AppAmbitMaui/AppAmbitMaui.csproj)
          echo "Project version: $VERSION"
          echo "csproj_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Package NuGets and set version
        id: package_set_version
        run: |
          NUPKG_Version="${NUPKG_MAJOR}"
          VERSION="${NUPKG_MAJOR}-ci${GITHUB_RUN_ID}"
          if [ "$GITHUB_EVENT_NAME" = "release" ]; then
            VERSION="${GITHUB_REF##*/}"
          fi
          echo "ngpkgversion=$NUPKG_Version" >> $GITHUB_OUTPUT
          echo "pkgverci=$VERSION" >> $GITHUB_OUTPUT
          echo "PACKAGE VERSION: $VERSION"

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Package NuGet
        run: dotnet pack --output ./artifacts --configuration Release -p:PackageVersion=${{ steps.project_version.outputs.csproj_version }} ./AppAmbitMaui/AppAmbitMaui.csproj 

      - name: Upload release asset
        id: create_release
        if: false # change this to true if you want to publish
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.project_version.outputs.csproj_version }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: ./artifacts/*.nupkg
          body: |
            AppAmbit v${{ steps.project_version.outputs.csproj_version }} - Preview Release
            This is the initial preview release of AppAmbit â€” designed to help developers easily track analytics, capture crashes, and monitor usage across mobile and desktop apps.
          prerelease: true
