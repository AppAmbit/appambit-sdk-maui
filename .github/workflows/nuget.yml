name: Build and Publish NuGet Package

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'If true, will push packages to NuGet (manual). Default: false'
        required: false
        default: 'false'

env:
  FOLDER_OUTPUT: artifacts
  RELEASE_TYPE: Release
  SDK_PATH: sdk/AppAmbit/AppAmbit.csproj
  SDK_MAUI_PATH: sdk/AppAmbit.Maui/AppAmbit.Maui.csproj
  SDK_AVALONIA_PATH: sdk/AppAmbit.Avalonia/AppAmbit.Avalonia.csproj

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: windows-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Read version from Directory.Build.props
        id: version
        shell: pwsh
        run: |
          [xml]$xml = Get-Content "Directory.Build.props"
          $version = $xml.Project.PropertyGroup.Version
          if (-not $version) { Write-Error "Cannot determine Version in Directory.Build.props"; exit 1 }
          echo "version_name=$version" >> $env:GITHUB_OUTPUT
          echo "new_tag=v$version" >> $env:GITHUB_OUTPUT
          if ($version -match '-') { echo "is_prerelease=true" >> $env:GITHUB_OUTPUT } else { echo "is_prerelease=false" >> $env:GITHUB_OUTPUT }

      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG=${{ steps.version.outputs.new_tag }}
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping build and pack."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Stop if tag exists
        if: steps.check_tag.outputs.skip_build == 'true'
        run: |
          echo "Build/Pack skipped because version tag already exists."
          exit 0

      - name: Extract latest changelog entry
        id: changelog
        shell: bash
        run: |
          LATEST_CHANGELOG=$(awk '/^## Version /{if (p) exit; p=1} p' CHANGELOG.md | sed '1d')
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$LATEST_CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Show changelog
        run: |
          echo "Last changes:"
          echo "${{ steps.changelog.outputs.changelog }}"

      - name: Create artifacts directory
        run: mkdir -p ${{ env.FOLDER_OUTPUT }}

      - name: Install .NET Workloads (Restore)
        run: dotnet workload restore

      - name: Pack AppAmbit (base)
        if: steps.check_tag.outputs.skip_build != 'true'
        run: |
          dotnet pack ${{ env.SDK_PATH }} --configuration "${{ env.RELEASE_TYPE }}" --output "${{ env.FOLDER_OUTPUT }}" -p:PackageVersion=${{ steps.version.outputs.version_name }}

      - name: Pack AppAmbit.Maui
        if: steps.check_tag.outputs.skip_build != 'true'
        run: |
          dotnet pack ${{ env.SDK_MAUI_PATH }} --configuration "${{ env.RELEASE_TYPE }}" --output "${{ env.FOLDER_OUTPUT }}" -p:PackageVersion=${{ steps.version.outputs.version_name }}

      - name: Pack AppAmbit.Avalonia
        if: steps.check_tag.outputs.skip_build != 'true'
        run: |
          dotnet pack ${{ env.SDK_AVALONIA_PATH }} --configuration "${{ env.RELEASE_TYPE }}" --output "${{ env.FOLDER_OUTPUT }}" -p:PackageVersion=${{ steps.version.outputs.version_name }}

      - name: Upload artifacts
        if: steps.check_tag.outputs.skip_build != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: AppAmbit-Packages-${{ steps.version.outputs.version_name }}
          path: ./${{ env.FOLDER_OUTPUT }}/*.nupkg

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: "${{ steps.version.outputs.new_tag }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          files: ./${{ env.FOLDER_OUTPUT }}/*.nupkg
          body: ${{ steps.changelog.outputs.changelog }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}

      - name: Skip publishing prerelease versions to NuGet
        if: ${{ github.event.inputs.publish == 'true' && steps.version.outputs.is_prerelease == 'true' }}
        run: |
          echo "Version ${{ steps.version.outputs.version_name }} is a prerelease; skipping publish to NuGet.org as requested."

      - name: Publish to NuGet (manual)
        if: ${{ github.event.inputs.publish == 'true' && steps.version.outputs.is_prerelease == 'false' }}
        shell: pwsh
        run: |
          Write-Host "Publishing all nupkgs in $env:FOLDER_OUTPUT to NuGet.org"
          $pkgs = Get-ChildItem -Path "${{ env.FOLDER_OUTPUT }}" -Filter "*.nupkg"
          if (-not $pkgs) { throw "No .nupkg found in $env:FOLDER_OUTPUT" }
          foreach ($pkg in $pkgs) {
            Write-Host "Pushing $($pkg.FullName)"
            dotnet nuget push "$($pkg.FullName)" `
              --api-key "${{ secrets.NUGET_APPKEY_SECRET }}" `
              --source https://api.nuget.org/v3/index.json `
              --skip-duplicate
          }