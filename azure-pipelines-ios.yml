trigger:
  branches:
    include:
      - develop

pr: none

pool:
  vmImage: 'macos-latest'

variables:
  - group: iOS VARIABLES
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetVersion
    value: '8.0.x'
  - name: projectPath
    value: 'AppAmbitTestingApp/AppAmbitTestingApp.csproj'
  - name: outputPath
    value: 'publish-ios'

jobs:
- job: BuildiOSIPA
  displayName: 'Build iOS IPA'
  condition: eq(variables['Build.SourceBranchName'], 'develop')
  timeoutInMinutes: 20

  steps:
    - checkout: self

    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        packageType: sdk
        version: '$(dotnetVersion)'

    - script: |
        if [ -d "/Applications/Xcode_16.2.app" ]; then
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
        else
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        fi
        sudo xcodebuild -license accept
        echo "Xcode path: $(xcode-select -p)"
        xcodebuild -version
      displayName: 'Select and confirm Xcode version'

    - script: |
        if [ ! -d "/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform" ]; then
          echo "Downloading iOS Platform SDK..."
          sudo xcodebuild -downloadPlatform iOS
        else
          echo "iOS Platform SDK already present, skipping download"
        fi

        if ! xcode-select -p &>/dev/null; then
          echo "Installing Xcode CLI tools..."
          sudo xcode-select --install
        else
          echo "Xcode CLI tools already installed"
        fi

        which actool || echo "actool not found"
      displayName: 'Ensure iOS SDK and Xcode CLI tools'

    - script: |
        if ! dotnet workload list | grep -q ios; then
          dotnet workload install maui ios
        fi
      displayName: 'Ensure MAUI iOS Workload installed'

    - script: |
        security delete-keychain build.keychain || true
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings -t 3600 -l build.keychain
      displayName: 'Reset Keychain'

    - task: DownloadSecureFile@1
      name: DownloadCertificate
      inputs:
        secureFile: 'AdHocCertificates.p12'
      displayName: 'Download P12 Certificate'

    - script: |
        security import "$(DownloadCertificate.secureFilePath)" -k build.keychain -P "$(IOS_APPLE_P12_PASSWORD)" -A
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
      displayName: 'Install P12 Certificate'

    - task: DownloadSecureFile@1
      name: DownloadProvision
      inputs:
        secureFile: 'AppAmbit_TestApp__AdHoc-2.mobileprovision'
      displayName: 'Download Provisioning Profile'

    - script: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        UUID=$(security cms -D -i "$(DownloadProvision.secureFilePath)" | plutil -extract UUID xml1 -o - - | xmllint --xpath "string(//string)" -)
        cp "$(DownloadProvision.secureFilePath)" ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
        echo "##vso[task.setvariable variable=ProvisioningUUID]$UUID"
      displayName: 'Install Provisioning Profile'

    - script: |
        dotnet restore "$(projectPath)"
      displayName: 'Restore Dependencies'

    - script: |
        export DEVELOPER_DIR=$(xcode-select -p)
        set -x
        dotnet publish "$(projectPath)" \
          -c $(buildConfiguration) -f net8.0-ios \
          -p:ArchiveOnBuild=true \
          -p:BuildIpa=true \
          -p:EnableAssemblyILStripping=false \
          -p:CodesignProvision=$(ProvisioningUUID) \
          -p:SdkRoot=$DEVELOPER_DIR/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk \
          -o $(outputPath)
      displayName: 'Build IPA (Release)'

    - script: |
        IPA_PATH=$(find "$(outputPath)" -name "*.ipa" | head -n 1)
        mv "$IPA_PATH" "$(outputPath)/AppAmbit.ipa"
        find "$(outputPath)" ! -name "AppAmbit.ipa" -type f -delete
      displayName: 'Keep only IPA in outputPath'

    - task: PublishBuildArtifacts@1
      displayName: 'Upload IPA Artifact'
      inputs:
        PathtoPublish: '$(outputPath)'
        ArtifactName: 'ios-ipa'
        publishLocation: 'Container'
